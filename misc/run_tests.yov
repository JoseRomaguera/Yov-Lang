
test_count : Int = 0;
failed_count : Int = 0;

main :: func
{
    set_cd("../");
    
    println("Running tests...");
    for (it := 0; it < 10; it += 1) {
        run_all_tests();
        if (failed_count > 0) break;
    }
    
    println("Failed: {failed_count}/{test_count}");
    exit(failed_count);
}

run_all_tests :: func
{
    run_test("examples/basics.yov", "", 0);
    run_test("examples/default_definitions.yov", "", 0);
    run_test("examples/errors.yov", "", 0);
    run_test("examples/external_calls.yov", "", 0);
    run_test("examples/file_system.yov", "", 0);
    run_test("examples/script_args.yov", "-foo=A", 0);
    
    run_test("tests/basics.yov", "", 0);
    run_test("tests/expressions.yov", "", 0);
    run_test("tests/references.yov", "", 0);
    run_test("tests/any.yov", "", 0);
}

run_test :: func (name: String, args: String, expected_code: Int)
{
    calls.redirect_stdout = RedirectStdout.Ignore;
    
    iterations :: 5;
    
    for (it := 0; it < iterations; it += 1) {
        test_count += 1;
        out, res := call_script(name, args, "-no_user");
        
        if (res.code != expected_code) {
            failed_count += 1;
            println("-> Test failed: {name}");
            println(out.stdout);
            return;
        }
        
    }
    
    if (iterations == 1) println("Test succeded: {name}");
    else println("Test succeded x{iterations}: {name}");
}